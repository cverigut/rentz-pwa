<!doctype html>
<html lang="ro">
<head>
  <!-- PWA manifest (doar pentru instalare pe device-uri reale; Ã®n sandbox nu se Ã®nregistreazÄƒ SW) -->
  <link rel="manifest" href="#pwa-manifest">
  <meta name="theme-color" content="#2563eb">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rentz Scoruri â€” PWA</title>
  <style>
    :root{--bg:#ffffff;--muted:#6b7280;--accent:#2563eb;--green:#16a34a;--red:#ef4444;--card:#f8fafc}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:var(--bg);color:#111}
    header{padding:14px 16px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;gap:12px;background:#ffffff;position:sticky;top:0;z-index:10}
    h1{font-size:18px;margin:0}
    .container{padding:16px;max-width:820px;margin:0 auto}
    .card{background:var(--card);padding:14px;border-radius:12px;margin-bottom:14px;border:1px solid #e5e7eb}
    label{font-weight:600;font-size:14px}
    input[type=text],input[type=number],select{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
    input[type=number]{-moz-appearance:textfield}
    input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{margin:0;-webkit-appearance:none}
    .seg{display:flex;gap:8px;margin:8px 0 12px}
    .seg button{flex:1;padding:8px 10px;border-radius:999px;border:1px solid #d1d5db;background:#fff;font-size:14px}
    .seg button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .row{display:flex;gap:8px;align-items:center;margin-top:6px}
    .row > div{flex:1}
    .games-table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    .games-table th,.games-table td{padding:6px 4px;border-bottom:1px solid #e5e7eb;text-align:left}
    .games-table th{text-align:left;font-weight:600;font-size:12px;color:var(--muted)}
    .tag{display:inline-flex;align-items:center;justify-content:center;padding:2px 6px;border-radius:999px;font-size:11px}
    .tag.neg{background:#fee2e2;color:#b91c1c}
    .tag.pos{background:#dcfce7;color:#166534}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:9px 14px;border-radius:10px;border:0;font-weight:600;font-size:14px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#fff;border:1px solid #d1d5db;color:#111}
    .btn.small{padding:5px 9px;font-size:12px}
    .stack{display:flex;flex-direction:column;gap:8px}
    .muted{color:var(--muted);font-size:13px}
    .hidden{display:none}
    .summary{display:flex;gap:8px;margin-top:10px}
    .summary .box{flex:1;background:#fff;border-radius:10px;padding:8px;text-align:center;border:1px solid #e5e7eb}
    .summary .minus{color:var(--red);font-weight:700}
    .summary .plus{color:var(--green);font-weight:700}
    .pill{border-radius:999px;padding:2px 8px;background:#e5e7eb;font-size:11px}
    .flex{display:flex;gap:8px;align-items:center}
    .flex-between{display:flex;align-items:center;justify-content:space-between}
    .game-option{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;margin-bottom:6px}
    .game-option.disabled{opacity:0.4}
    .game-option .name{font-size:14px;font-weight:500}
    .game-option .points{font-size:13px}
    .game-option .points.neg{color:var(--red)}
    .game-option .points.pos{color:var(--green)}
    table.score{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    table.score th,table.score td{padding:6px 4px;border-bottom:1px solid #e5e7eb;text-align:left}
    table.score th{font-size:12px;color:var(--muted)}
    footer{padding:12px 16px;text-align:center;font-size:12px;color:var(--muted)}
    .badge{border-radius:999px;padding:2px 7px;font-size:11px;background:#e0f2fe;color:#0369a1}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,0.45);display:flex;align-items:center;justify-content:center;z-index:50}
    .modal-backdrop.hidden{display:none !important;}
    .modal{background:#fff;border-radius:14px;padding:14px;max-width:420px;width:100%;box-shadow:0 20px 35px rgba(15,23,42,0.2)}
  </style>
  <script src="./jspdf.umd.min.js"></script>
</head>
<body>
<header>
  <h1>Rentz Scoruri</h1>
  <span class="badge">demo PWA</span>
</header>
<div class="container">

  <!-- Screen 1: numÄƒr jucÄƒtori -->
  <div id="screen-players-count" class="card">
    <label>1. Alege numÄƒrul de jucÄƒtori</label>
    <div class="muted" style="margin-top:4px">PoÈ›i juca Ã®n 4, 5 sau 6 jucÄƒtori.</div>
    <div class="seg" style="margin-top:10px">
      <button data-val="4">4 jucÄƒtori</button>
      <button data-val="5">5 jucÄƒtori</button>
      <button data-val="6" class="active">6 jucÄƒtori</button>
    </div>
    <div style="margin-top:10px" class="flex-between">
      <span class="muted">ContinuÄƒ pentru a introduce numele.</span>
      <button class="btn primary" id="btnToNames">ContinuÄƒ â†’</button>
    </div>
    <div style="margin-top:8px">
      <button class="btn ghost small" id="btnResume" style="display:none;">Reia joc salvat</button>
    </div>
  </div>

  <!-- Screen 2: nume jucÄƒtori -->
  <div id="screen-player-names" class="card hidden">
    <label>2. Numele jucÄƒtorilor</label>
    <div id="namesInputs" class="stack" style="margin-top:10px"></div>
    <div class="flex-between" style="margin-top:10px">
      <button class="btn ghost" id="btnBackToCount">â† Ãnapoi</button>
      <button class="btn primary" id="btnToGamesSetup">ContinuÄƒ â†’</button>
    </div>
  </div>

  <!-- Screen 3: iniÈ›ializare jocuri -->
  <div id="screen-games-setup" class="card hidden">
    <label>3. IniÈ›ializare jocuri</label>
    <div class="muted" style="margin-top:4px">EditeazÄƒ lista de jocuri, tipul (+/-) È™i punctajul. BifeazÄƒ ce jocuri se joacÄƒ Ã®n partida curentÄƒ.</div>

    <div class="summary" id="summaryPlusMinus" style="margin-top:10px">
      <div class="box"><div class="muted">Total minus</div><div id="sumMinus" class="minus" style="font-weight:700">0</div></div>
      <div class="box"><div class="muted">Total plus</div><div id="sumPlus" class="plus" style="font-weight:700">0</div></div>
    </div>

    <table class="games-table" id="gamesTable">
      <thead>
        <tr>
          <th>Se joacÄƒ</th>
          <th>Joc</th>
          <th>Tip</th>
          <th>Total joc</th>
        </tr>
      </thead>
      <tbody id="gamesTbody"></tbody>
    </table>

    <div class="flex" style="margin-top:10px">
      <button class="btn ghost small" id="btnAddGame">ï¼‹ AdaugÄƒ joc nou</button>
      <span class="muted">DupÄƒ start, jocurile se blocheazÄƒ pÃ¢nÄƒ la finalul partidei.</span>
    </div>

    <div class="summary">
      <div class="box">
        <div class="muted">Total jocuri active</div>
        <div id="cntGames" style="font-weight:700">0</div>
      </div>
      <div class="box">
        <div class="muted">Total runde (jucÄƒtori Ã— jocuri)</div>
        <div id="cntRounds" style="font-weight:700">0</div>
      </div>
    </div>

    <div class="flex-between" style="margin-top:12px">
      <button class="btn primary small" id="btnSaveGameConfig">ğŸ’¾ SalveazÄƒ configurarea jocurilor</button>
      <button class="btn ghost" id="btnBackToNames">â† Ãnapoi</button>
      <button class="btn primary" id="btnStartMatch">Start meci â†’</button>
    </div>
  </div>

  <!-- Screen 4: rulare meci -->
  <div id="screen-match" class="card hidden">
    <div class="flex-between">
      <div>
        <div class="muted">Runda <span id="roundIndex">1</span> / <span id="roundTotal">1</span></div>
        <div style="font-weight:700;margin-top:2px">La alegere: <span id="currentPlayerName">-</span></div>
      </div>
      <div class="flex">
        <button class="btn ghost small" id="btnManualSave">ğŸ’¾ SalveazÄƒ meciul</button>
        <button class="btn ghost small" id="btnShowScore">Vezi scor</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="muted">Alege jocul pentru aceastÄƒ rundÄƒ</div>
      <div id="gameChoices" style="margin-top:8px"></div>
      <button class="btn primary" id="btnChooseGame" style="margin-top:8px">ConfirmÄƒ jocul</button>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="muted">Istoric alegeri (pe runde):</div>
      <div id="historyBox" class="muted" style="margin-top:4px;font-size:12px"></div>
    </div>
  </div>

  <!-- Screen 5: scoreboard final / live -->
  <div id="screen-score" class="card hidden">
    <div class="flex-between">
      <h3 style="margin:0;font-size:16px">Scoreboard</h3>
      <button class="btn ghost small" id="btnBackToMatch">Ãnapoi la meci</button>
    </div>
    <div id="scoreTableWrap" style="margin-top:6px"></div>
    <button class="btn primary small" id="btnExportPDF" style="margin-top:10px;">ğŸ“„ ExportÄƒ Clasament Final (PDF)</button>
  </div>

</div>

<footer>
  Datele sunt pÄƒstrate local Ã®n browser (nu se trimit nicÄƒieri).
</footer>

<!-- Modal introducere scoruri -->
<div id="modalBackdrop" class="modal-backdrop hidden">
  <div class="modal">
    <h3 id="modalTitle" style="margin:0 0 6px;font-size:16px">Scoruri rundÄƒ</h3>
    <div id="modalGameInfo" class="muted" style="margin-bottom:8px"></div>
    <div id="modalScores" class="stack"></div>
    <div id="modalHint" class="muted" style="margin-top:4px;font-size:12px"></div>
    <div class="flex" style="margin-top:10px;justify-content:space-between">
      <span class="muted" style="font-size:16px;display:flex;align-items:center">â„¹ï¸</span>
      <button class="btn primary small" id="btnSaveScores">SalveazÄƒ scorurile</button>
    </div>
  </div>
</div>

<script>
// ---- STATE ----
let numPlayers = 6;
let players = []; // {name, color}
let allGames = []; // {id, name, type:'+/-', total:number, active:boolean, builtin:boolean, rentzValues?}
let activeGames = [];
let totalRounds = 0;
let currentRoundIndex = 0;
let picksByPlayer = {}; // playerIndex -> Set(gameId)
let roundHistory = [];
let scoresPerPlayer = [];

const palette = ['#ef4444','#22c55e','#3b82f6','#f97316','#8b5cf6','#06b6d4'];
const STORAGE_KEY = 'rentz_match_state_v1';

function saveMatchState(){
  try{
    if(typeof localStorage === 'undefined') return;exportFinalPDF
    const simplePicks = {};
    Object.keys(picksByPlayer || {}).forEach(k=>{
      simplePicks[k] = Array.from(picksByPlayer[k] || []);
    });
    const state = {
      numPlayers,
      players,
      allGames,
      totalRounds,
      currentRoundIndex,
      picksByPlayer: simplePicks,
      roundHistory,
      scoresPerPlayer
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }catch(e){ console.error('saveMatchState error', e); }
}

function loadMatchState(){
  try{
    if(typeof localStorage === 'undefined') return false;
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    const state = JSON.parse(raw);
    if(!state || !state.players || !state.allGames) return false;
    numPlayers = state.numPlayers || state.players.length;
    players = state.players || [];
    allGames = state.allGames || [];
    activeGames = allGames.filter(g=>g.active);
    totalRounds = state.totalRounds || (activeGames.length * numPlayers);
    currentRoundIndex = state.currentRoundIndex || 0;
    scoresPerPlayer = state.scoresPerPlayer || new Array(numPlayers).fill(0);
    picksByPlayer = {};
    if(state.picksByPlayer){
      Object.keys(state.picksByPlayer).forEach(k=>{
        picksByPlayer[k] = new Set(state.picksByPlayer[k] || []);
      });
    } else {
      for(let i=0;i<numPlayers;i++) picksByPlayer[i] = new Set();
    }
    roundHistory = state.roundHistory || [];
    const rt = document.getElementById('roundTotal');
    if(rt) rt.textContent = totalRounds;
    updateRoundsSummary();
    return true;
  }catch(e){ console.error('loadMatchState error', e); return false; }
}

function setupResumeButton(){
  try{
    if(typeof localStorage === 'undefined') return;
    const raw = localStorage.getItem(STORAGE_KEY);
    const btn = document.getElementById('btnResume');
    if(!btn) return;
    if(!raw){
      btn.style.display = 'none';
      return;
    }
    btn.style.display = 'inline-flex';
    btn.addEventListener('click',()=>{
      const ok = loadMatchState();
      if(ok){
        showScreen('screen-match');
        updateMatchUI();
      } else {
        showAlert('Nu s-a putut Ã®ncÄƒrca jocul salvat.');
      }
    });
  }catch(e){ console.error('setupResumeButton error', e); }
}

function setupManualSave(){
  const btn = document.getElementById('btnManualSave');
  if(!btn) return;
  btn.addEventListener('click',()=>{
    saveMatchState();
    showAlert('Meciul a fost salvat pe acest dispozitiv.');
  });
}


function init(){
  // numÄƒr jucÄƒtori
  document.querySelectorAll('#screen-players-count .seg button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('#screen-players-count .seg button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      numPlayers = Number(btn.dataset.val);
      updateRoundsSummary();
    });
  });

  document.getElementById('btnToNames').addEventListener('click',()=>{
    showScreen('screen-player-names');
    renderNameInputs();
  });

  document.getElementById('btnBackToCount').addEventListener('click',()=>{
    showScreen('screen-players-count');
  });

  document.getElementById('btnToGamesSetup').addEventListener('click',()=>{
    if(!readPlayerNames()) return;
    ensureDefaultGames();
    renderGamesTable();
    showScreen('screen-games-setup');
  });

  document.getElementById('btnBackToNames').addEventListener('click',()=>{
    showScreen('screen-player-names');
  });

  document.getElementById('btnAddGame').addEventListener('click',addNewGame);
  document.getElementById('btnSaveGameConfig').addEventListener('click',()=>{
    showAlert('Configurarea jocurilor a fost salvatÄƒ.');
  });

  document.getElementById('btnStartMatch').addEventListener('click',startMatch);

  document.getElementById('btnChooseGame').addEventListener('click',onChooseGame);
  document.getElementById('btnShowScore').addEventListener('click',()=>{
    renderScoreboard();
    showScreen('screen-score');
  });
  document.getElementById('btnBackToMatch').addEventListener('click',()=>{
    showScreen('screen-match');
  });

  const btnExport = document.getElementById('btnExportPDF');
  if(btnExport){
    btnExport.addEventListener('click', exportFinalPDF);
  }

  document.getElementById('btnSaveScores').addEventListener('click',saveScoresFromModal);

  setupResumeButton();
  setupManualSave();

  updateRoundsSummary();
}

function showScreen(id){
  ['screen-players-count','screen-player-names','screen-games-setup','screen-match','screen-score']
    .forEach(s=>document.getElementById(s).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

// ---- PLAYERS ----
function renderNameInputs(){
  const wrap = document.getElementById('namesInputs');
  wrap.innerHTML = '';
  for(let i=0;i<numPlayers;i++){
    const row = document.createElement('div');
    row.className = 'row';
    const left = document.createElement('div');
    left.innerHTML = `<label>JucÄƒtor ${i+1}</label>`;
    const right = document.createElement('div');
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = `Nume jucÄƒtor ${i+1}`;
    input.id = 'player_name_'+i;
    right.appendChild(input);
    row.appendChild(left);
    row.appendChild(right);
    wrap.appendChild(row);
  }
}

function readPlayerNames(){
  players = [];
  for(let i=0;i<numPlayers;i++){
    const inp = document.getElementById('player_name_'+i);
    const name = (inp.value || '').trim() || `JucÄƒtor ${i+1}`;
    players.push({name, color:palette[i % palette.length]});
  }
  return true;
}

// ---- GAMES SETUP ----
function ensureDefaultGames(){
  if(allGames.length>0) return;
  allGames = [
    {id:'dame',name:'Dame',type:'-',total:160,active:true,builtin:true},
    {id:'kheart',name:'K de InimÄƒ',type:'-',total:100,active:true,builtin:true},
    {id:'caro',name:'Carouri',type:'-',total:120,active:true,builtin:true},
    {id:'last2',name:'Last 2',type:'-',total:150,active:true,builtin:true},
    {id:'qhearts',name:'Dama de PicÄƒ + Inimi',type:'-',total:310,active:true,builtin:true},
    {id:'totaluri',name:'Totaluri',type:'-',total:460,active:true,builtin:true},
    {id:'rentz',name:'Rentz',type:'+',total:1060,active:true,builtin:true,rentzValues:[310,250,200,150,100,50]},
    {id:'atu',name:'Atu',type:'+',total:240,active:true,builtin:true},
    {id:'tenclubs',name:'10 de Trefla',type:'+',total:100,active:false,builtin:true}
  ];
}

function renderGamesTable(){
  const tb = document.getElementById('gamesTbody');
  tb.innerHTML = '';

  allGames.forEach(g=>{
    if(g.id !== 'rentz'){
      const tr = document.createElement('tr');

      const tdActive = document.createElement('td');
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.checked = !!g.active;
      chk.addEventListener('change',()=>{g.active = chk.checked; updateRoundsSummary();});
      tdActive.appendChild(chk);
      tr.appendChild(tdActive);

      const tdName = document.createElement('td');
      const inpName = document.createElement('input');
      inpName.type = 'text';
      inpName.value = g.name;
      inpName.style.fontSize = '13px';
      inpName.addEventListener('input',()=>{g.name = inpName.value;});
      tdName.appendChild(inpName);
      tr.appendChild(tdName);

      const tdType = document.createElement('td');
      const sel = document.createElement('select');
      sel.innerHTML = '<option value="-">-</option><option value="+">+</option>';
      sel.value = g.type;
      sel.addEventListener('change',()=>{g.type = sel.value; updateRoundsSummary();});
      tdType.appendChild(sel);
      tr.appendChild(tdType);

      const tdTotal = document.createElement('td');
      const inpTotal = document.createElement('input');
      inpTotal.type = 'number';
      inpTotal.inputMode = 'numeric';
      inpTotal.value = g.total || 0;
      inpTotal.min = '0';
      inpTotal.addEventListener('input',()=>{ g.total = Number(inpTotal.value||0); updateRoundsSummary(); });
      tdTotal.appendChild(inpTotal);
      tr.appendChild(tdTotal);

      tb.appendChild(tr);
    } else {
      // Rentz: 6 rÃ¢nduri, cÃ¢te unul per loc
      if(!g.rentzValues) g.rentzValues = [310,250,200,150,100,50];
      for(let place=1; place<=6; place++){
        const tr = document.createElement('tr');

        const tdActive = document.createElement('td');
        if(place===1){
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.checked = !!g.active;
          chk.addEventListener('change',()=>{g.active = chk.checked; updateRoundsSummary();});
          tdActive.appendChild(chk);
        }
        tr.appendChild(tdActive);

        const tdName = document.createElement('td');
        tdName.textContent = `Rentz â€“ Loc ${place}`;
        tr.appendChild(tdName);

        const tdType = document.createElement('td');
        tdType.textContent = '+';
        tr.appendChild(tdType);

        const tdTotal = document.createElement('td');
        const inp = document.createElement('input');
        inp.type = 'number';
      inp.inputMode = 'numeric';
        inp.min = '0';
        inp.value = g.rentzValues[place-1] || 0;
        inp.addEventListener('input',()=>{
          g.rentzValues[place-1] = Number(inp.value||0);
          g.total = g.rentzValues.reduce((s,v)=>s+v,0);
          updateRoundsSummary();
        });
        tdTotal.appendChild(inp);
        tr.appendChild(tdTotal);

        tb.appendChild(tr);
      }
    }
  });
  updateRoundsSummary();
}

function addNewGame(){
  const id = 'custom_'+Date.now();
  allGames.push({id,name:'Joc nou',type:'+',total:0,active:true,builtin:false});
  renderGamesTable();
}

function updateRoundsSummary(){
  const activeCount = allGames.filter(g=>g.active).length;
  document.getElementById('cntGames').textContent = activeCount;
  const rounds = activeCount * numPlayers;
  document.getElementById('cntRounds').textContent = rounds;

  let sumMinus = 0, sumPlus = 0;
  allGames.forEach(g=>{
    if(!g.active) return;
    const t = Number(g.total)||0;
    if(g.type === '-') sumMinus += t;
    else sumPlus += t;
  });
  document.getElementById('sumMinus').textContent = sumMinus;
  document.getElementById('sumPlus').textContent = sumPlus;
}

// ---- MATCH ----
function startMatch(){
  // VALIDARE: toate jocurile active trebuie sÄƒ aibÄƒ total > 0
  for(const g of allGames){
    if(g.active && (!g.total || g.total <= 0)){
      showAlert('Jocul "' + g.name + '" are totalul setat la 0. SeteazÄƒ un total mai mare Ã®nainte de a continua.');
      return;
    }
  }
  activeGames = allGames.filter(g=>g.active);
  if(activeGames.length===0){
    showAlert('SelecteazÄƒ cel puÈ›in un joc pentru partidÄƒ.');
    return;
  }
  totalRounds = activeGames.length * numPlayers;
  currentRoundIndex = 0;
  picksByPlayer = {};
  for(let i=0;i<numPlayers;i++) picksByPlayer[i] = new Set();
  roundHistory = [];
  scoresPerPlayer = new Array(numPlayers).fill(0);

  document.getElementById('roundTotal').textContent = totalRounds;
  updateMatchUI();
  saveMatchState();
  showScreen('screen-match');
}

function updateMatchUI(){
  if(currentRoundIndex >= totalRounds){
    renderScoreboard();
    showScreen('screen-score');
    return;
  }
  const roundNo = currentRoundIndex + 1;
  const playerIndex = currentRoundIndex % numPlayers;
  const player = players[playerIndex];

  document.getElementById('roundIndex').textContent = roundNo;
  document.getElementById('currentPlayerName').textContent = player.name;

  const wrap = document.getElementById('gameChoices');
  wrap.innerHTML = '';

  activeGames.forEach(g=>{
    const alreadyPicked = picksByPlayer[playerIndex].has(g.id);
    const opt = document.createElement('div');
    opt.className = 'game-option' + (alreadyPicked ? ' disabled' : '');

    const left = document.createElement('div');
    const nameDiv = document.createElement('div');
    nameDiv.className = 'name';
    nameDiv.textContent = g.name;
    const infoDiv = document.createElement('div');
    infoDiv.className = 'muted';
    infoDiv.style.fontSize = '11px';
    if(g.id === 'rentz' && g.rentzValues){
      infoDiv.textContent = 'Rentz (total ' + g.total + ')';
    } else {
      infoDiv.textContent = 'Total joc: ' + g.total;
    }
    left.appendChild(nameDiv);
    left.appendChild(infoDiv);

    const right = document.createElement('div');
    right.className = 'flex';
    const tag = document.createElement('span');
    tag.className = 'tag ' + (g.type==='-'?'neg':'pos');
    tag.textContent = g.type==='-' ? 'minus' : 'plus';
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'gameChoice';
    radio.value = g.id;
    radio.disabled = alreadyPicked;

    const points = document.createElement('span');
    points.className = 'points ' + (g.type==='-'?'neg':'pos');
    points.textContent = g.type==='-' ? 'joc negativ' : 'joc pozitiv';

    right.appendChild(tag);
    right.appendChild(points);
    right.appendChild(radio);

    opt.appendChild(left);
    opt.appendChild(right);
    wrap.appendChild(opt);
  });

  const hb = document.getElementById('historyBox');
  hb.innerHTML = '';
  roundHistory.forEach(r=>{
    hb.innerHTML += `R${r.round}: ${r.playerName} â†’ ${r.gameName}<br>`;
  });
}

function onChooseGame(){
  const sel = document.querySelector('input[name="gameChoice"]:checked');
  if(!sel){
    showAlert('Alege un joc pentru rundÄƒ.');
    return;
  }
  const gameId = sel.value;
  const g = activeGames.find(x=>x.id===gameId);
  if(!g) return;
  openScoresModal(g);
}

function openScoresModal(game){
  document.getElementById('modalTitle').textContent = `Scoruri pentru jocul: ${game.name}`;
  document.getElementById('modalGameInfo').textContent = game.id === 'rentz' && game.rentzValues ? `Locuri: ${game.rentzValues.join(', ')}` : `Total joc: ${game.total}`;

  const area = document.getElementById('modalScores');
  area.innerHTML='';

  if(game.id === 'rentz'){
    // introducem LOCUL (1-6) pentru fiecare jucÄƒtor
    players.forEach((p,idx)=>{
      const row = document.createElement('div');
      row.className = 'row';
      const left = document.createElement('div'); left.textContent = p.name;
      const right = document.createElement('div');
      const inp = document.createElement('input');
      inp.type = 'number';
      inp.inputMode = 'numeric';
      inp.min = '1';
      inp.max = '6';
      inp.placeholder = 'loc (1-6)';
      inp.dataset.index = idx;
      right.appendChild(inp);
      row.appendChild(left);
      row.appendChild(right);
      area.appendChild(row);
    });
    document.getElementById('modalHint').textContent = 'Introdu locul (1-6) pentru fiecare jucÄƒtor. Fiecare loc trebuie folosit o singurÄƒ datÄƒ.';
  } else {
    players.forEach((p,idx)=>{
      const row = document.createElement('div');
      row.className = 'row';
      const left = document.createElement('div'); left.textContent = p.name;
      const right = document.createElement('div');
      const inp = document.createElement('input');
      inp.type = 'number';
      inp.inputMode = 'numeric';
      inp.min = '0';
      inp.placeholder = '0';
      inp.dataset.index = idx;
      right.appendChild(inp);
      row.appendChild(left);
      row.appendChild(right);
      area.appendChild(row);
    });
    const hint = game.type==='-' ? 'Introdu valori pozitive (aplicaÈ›ia le va transforma automat Ã®n minus).' : 'Introdu valori pozitive (aplicaÈ›ia le pÄƒstreazÄƒ cu plus).';
    document.getElementById('modalHint').textContent = hint;
  }

  document.getElementById('modalBackdrop').dataset.gameId = game.id;
  document.getElementById('modalBackdrop').classList.remove('hidden');
}

function hideScoresModal(){
  document.getElementById('modalBackdrop').classList.add('hidden');
}

function saveScoresFromModal(){
  const gameId = document.getElementById('modalBackdrop').dataset.gameId;
  const game = activeGames.find(g=>g.id===gameId);
  if(!game) return;

  const inputs = Array.from(document.querySelectorAll('#modalScores input'));

  let perPlayer = new Array(players.length).fill(0);

  if(game.id === 'rentz'){
    // citim locurile 1-6
    const places = inputs.map(inp=>Number(inp.value||0));
    const used = new Set();
    for(const pl of places){
      if(pl < 1 || pl > 6){
        showAlert('Toate locurile la Rentz trebuie sÄƒ fie Ã®ntre 1 È™i 6.');
        return;
      }
      if(used.has(pl)){
        showAlert('Fiecare loc (1-6) poate fi folosit o singurÄƒ datÄƒ.');
        return;
      }
      used.add(pl);
    }
    if(used.size !== 6){
      showAlert('Trebuie folosite toate locurile de la 1 la 6, cÃ¢te o singurÄƒ datÄƒ.');
      return;
    }
    // mapÄƒm loc -> valoare Rentz
    const vals = game.rentzValues || [310,250,200,150,100,50];
    perPlayer = places.map(pl=> vals[pl-1] || 0);
    const sumAbs = perPlayer.reduce((s,v)=>s+Math.abs(v),0);
    if(sumAbs !== game.total){
      const diff = game.total - sumAbs;
      const msg = diff>0 ?
        ('Totalul Rentz este cu ' + diff + ' puncte MAI MIC decÃ¢t totalul setat ('+game.total+').') :
        ('Totalul Rentz este cu ' + (-diff) + ' puncte MAI MARE decÃ¢t totalul setat ('+game.total+').');
      showAlert(msg);
      return;
    }
  } else {
    // joc normal: valori de punctaj
    const rawVals = inputs.map(inp=>{
      const v = Number(inp.value || '0');
      // AcceptÄƒm È™i valori cu minus, dar lucrÄƒm pe valoare absolutÄƒ
      return isNaN(v) ? 0 : Math.abs(v);
    });
    const sumAbs = rawVals.reduce((s,v)=>s+v,0);
    if(sumAbs !== Math.abs(game.total)){
      const diff = Math.abs(game.total) - sumAbs;
      const msg = diff>0 ?
        ('Totalul pentru jocul ' + game.name + ' este cu ' + diff + ' puncte MAI MIC decÃ¢t totalul setat ('+game.total+').') :
        ('Totalul pentru jocul ' + game.name + ' este cu ' + (-diff) + ' puncte MAI MARE decÃ¢t totalul setat ('+game.total+').');
      showAlert(msg);
      return;
    }
    perPlayer = rawVals.map(v=> game.type==='-' ? -Math.abs(v) : Math.abs(v));
  }

  // actualizÄƒm totalurile
  perPlayer.forEach((v,idx)=>{ scoresPerPlayer[idx] += v; });

  const roundNo = currentRoundIndex + 1;
  const playerIndex = currentRoundIndex % numPlayers;
  const player = players[playerIndex];
  picksByPlayer[playerIndex].add(gameId);
  roundHistory.push({round:roundNo, playerIndex, playerName:player.name, gameId, gameName:game.name});

  hideScoresModal();

  currentRoundIndex++;
  saveMatchState();
  if(currentRoundIndex >= totalRounds){
    try{
      if(typeof localStorage !== 'undefined'){ localStorage.removeItem(STORAGE_KEY); }
    }catch(e){ console.error('clear storage error', e); }

    renderScoreboard();
    showScreen('screen-score');
  } else {
    updateMatchUI();
  }
}

// ---- SCOREBOARD ----
function renderScoreboard(){
  const wrap = document.getElementById('scoreTableWrap');
  wrap.innerHTML='';
  const table = document.createElement('table');
  table.className = 'score';

  const thead = document.createElement('thead');
  const hr = document.createElement('tr');
  let th = document.createElement('th'); th.textContent = 'JucÄƒtor'; hr.appendChild(th);
  th = document.createElement('th'); th.textContent = 'Total'; hr.appendChild(th);
  thead.appendChild(hr); table.appendChild(thead);

  const tbody = document.createElement('tbody');
  players.forEach((p,idx)=>{
    const tr = document.createElement('tr');
    const tdName = document.createElement('td'); tdName.textContent = p.name; tr.appendChild(tdName);
    const tdTotal = document.createElement('td');
    const val = scoresPerPlayer[idx] || 0;
    tdTotal.textContent = val>0?('+'+val):val;
    tdTotal.style.color = val>0? 'var(--green)' : (val<0? 'var(--red)' : '#111');
    tr.appendChild(tdTotal);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrap.appendChild(table);
}

// ---- EXPORT PDF ----
function exportFinalPDF(){
  // Feedback imediat cÄƒ s-a apÄƒsat butonul
  showAlert('Se genereazÄƒ fiÈ™ierul PDF cu clasamentul final...');

  try{
    // Compatibilitate: jsPDF poate fi expus ca window.jspdf.jsPDF sau window.jsPDF
    const jsPDFCtor = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : (window.jsPDF || null);
    if(!jsPDFCtor){
      showAlert('Biblioteca jsPDF nu este Ã®ncÄƒrcatÄƒ. VerificÄƒ conexiunea la internet È™i Ã®ncearcÄƒ din nou.');
      return;
    }

    const doc = new jsPDFCtor();

    const title = 'Rentz - Clasament Final';
    const today = new Date().toLocaleDateString('ro-RO');

    doc.setFontSize(18);
    doc.text(title, 105, 20, { align: 'center' });

    doc.setFontSize(11);
    doc.text('Data: ' + today, 105, 28, { align: 'center' });

    doc.setFontSize(12);
    doc.text('Numar jucatori: ' + players.length, 14, 40);
    doc.text('Runde totale: ' + totalRounds, 14, 47);

    doc.setFontSize(14);
    doc.text('Clasament final', 14, 62);

    doc.setFontSize(12);
    let y = 72;

    const ranking = players
      .map((p, idx) => ({ name: p.name, score: scoresPerPlayer[idx] || 0 }))
      .sort((a, b) => b.score - a.score);

    ranking.forEach((r, i) => {
      const scoreTxt = (r.score > 0 ? '+' : '') + r.score;
      doc.text((i + 1) + '. ' + r.name + ' - ' + scoreTxt, 14, y);
      y += 8;
    });

    doc.setFontSize(10);
    doc.text('Clasament generat automat de aplicatia Rentz Scoruri', 105, 285, { align: 'center' });

    const pdfBlob = doc.output('blob');
    const pdfUrl = URL.createObjectURL(pdfBlob);
    const link = document.createElement('a');
    link.href = pdfUrl;
    link.download = 'clasament_rentz.pdf';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(pdfUrl);
  }catch(e){
    console.error('exportFinalPDF error', e);
    showAlert('A apÄƒrut o eroare la generarea PDF-ului. ÃncearcÄƒ din nou.');
  }
}

// ---- INIT ----
document.addEventListener('DOMContentLoaded', () => {
  init();
  showScreen('screen-players-count');
});
</script>

<!-- Custom Alert Modal -->
<div id="alertBackdrop" class="modal-backdrop hidden">
  <div class="modal">
    <h3 style="margin:0 0 6px;font-size:16px">AtenÈ›ie</h3>
    <div id="alertMessage" style="margin:10px 0;font-size:14px"></div>
    <button class="btn primary small" id="alertOkBtn">OK</button>
  </div>
</div>

<script>
function showAlert(msg){
  document.getElementById('alertMessage').textContent = msg;
  document.getElementById('alertBackdrop').classList.remove('hidden');
}
function hideAlert(){
  document.getElementById('alertBackdrop').classList.add('hidden');
}
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('alertOkBtn').addEventListener('click', hideAlert);
});
</script>

<script>
// --- Create manifest dynamically (fÄƒrÄƒ service worker Ã®n sandbox) ---
const manifestData = {
  name: "Rentz Scoruri",
  short_name: "Rentz",
  start_url: "./",
  display: "standalone",
  background_color: "#ffffff",
  theme_color: "#2563eb",
  icons: [
    { src: "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f0cf.svg", sizes: "192x192", type: "image/svg+xml" },
    { src: "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f0cf.svg", sizes: "512x512", type: "image/svg+xml" }
  ]
};

const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(manifestBlob);

const manifestLink = document.querySelector('link[rel=manifest]');
if(manifestLink){
  manifestLink.setAttribute('href', manifestURL);
}

// NOTÄ‚: Nu Ã®nregistrÄƒm service worker Ã®n sandbox (blob: nu este acceptat pentru SW).
</script>

</body>
</html>
